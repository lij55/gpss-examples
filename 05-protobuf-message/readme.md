# Config pljava
Download gppkg of pljava from https://network.pivotal.io/products/pivotal-gpdb
Install pljava by gppkg command:
```bash
gppkg -i pljava-2.0.2-gp6-rhel7_x86_64.gppkg
```

After that, confirm the `JAVA_HOME` is correct in `greenplum_path.sh`. for example
```bash
#BEGIN EXTENSION PLJAVA
export JAVA_HOME=/usr/lib/jvm/
# for jdk 8
LD_LIBRARY_PATH=$JAVA_HOME/jre/lib/amd64/server:$LD_LIBRARY_PATH
# for jdk 11
LD_LIBRARY_PATH=$JAVA_HOME/lib/server:$LD_LIBRARY_PATH
export LD_LIBRARY_PATH
export PATH=$JAVA_HOME/bin:$PATH
#END EXTENSION PLJAVA
```

Now you can restart cluster and create extension of pljava
```sql
# create extension gpss; 
```

# Prepare jar file
You can find more about how to write pl/java from here:
- https://gpdb.docs.pivotal.io/5270/ref_guide/extensions/pl_java.html
- https://books.google.co.jp/books?id=St18DwAAQBAJ

There is a sample maven project in `project` folder. You can import with Intellij or other IDE.
It will build a fatjar for pljava.


# Protubuf example
The sample protubuf message used in this example is in `message.proto`. 
The related java code is generated by command
```bash
protoc message.proto
```
The test project can generate a sample message.
You can generate more if needed.
# Run test
Les's test it now.
Create target table and required type in Greenplum:
```sql
CREATE TYPE person
        AS (id integer,
            last text,
            first text,
            address text,
            age integer);
create table mypb (id integer,
                   name text,
                   age integer);
CREATE FUNCTION decperson(bytea)
    RETURNS person
    AS 'ListPeople.tupleReturn'
    IMMUTABLE LANGUAGE java;
```

The sample gpss job is below:
```yaml
DATABASE: test
USER: gpadmin
PASSWORD: ****
HOST: mdw
PORT: 5432
VERSION: 2
KAFKA:
  INPUT:
    SOURCE:
      BROKERS: kafka00host:9092
      TOPIC: pbtopic
    VALUE:
      COLUMNS:
      - NAME: c1
        TYPE: bytea
      FORMAT: binary

  OUTPUT:
    TABLE: mypb
    MODE: MERGE
    MAPPING:
      - NAME: id
        EXPRESSION: (decperson(c1)).id
      - NAME: name
        EXPRESSION: (decperson(c1)).first || ' ' || (decperson(c1)).last
      - NEME: age
        EXPRESSION: (decperson(c1)).age

  COMMIT:
    MINIMAL_INTERVAL: 2000

```